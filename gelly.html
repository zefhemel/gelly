<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <script src="aterm.js" type="application/javascript"></script>
  <script src="aterm.traversal.js" type="application/javascript"></script>
  <script src="parser.js" type="application/javascript"></script>
  <script src="compiler.js" type="application/javascript"></script>
</head>
<body>
  <p><textarea id="code" rows="20" cols="60" style="font-family: 'Courier';" onkeyup="parseIt()">var x = 8 * 8
alert(x)</textarea>
  <textarea id="parsed" rows="20" cols="60" style="font-family: 'Courier';"></textarea></p>
  <p><textarea id="rules" rows="20" cols="60" style="font-family: 'Courier';" onkeyup="parseIt()">my-rule : Keyword("var", Op("=", Sym(<var>), <exp>)) -> VarDeclInit(<var>, <exp>)

handle-calls : Op("_", Sym(<fn>), ParList(<args>)) -> Call(<fn>, <args>)</textarea>
  <textarea id="transformed" rows="20" cols="60" style="font-family: 'Courier';" onkeyup="parseIt()"></textarea>></p>
  <div id="error" style="color: red;"></div>
  <p>Keywords: <input type="text" id="keywords" value="" style="width: 100%;"/></p>
  <script>
    function init() {
      document.getElementById("code").value = localStorage["code"];
      document.getElementById("rules").value = localStorage["rules"];
      parseIt();
    }
    function parseIt() {
      var code = document.getElementById("code").value;
      localStorage["code"] = code;
      var rulesCode = document.getElementById("rules").value;
      localStorage["rules"] = rulesCode;
      var keywords = document.getElementById("keywords").value.split(/\s+/);
      var errEl = document.getElementById("error");
      errEl.innerText = "";
      try {
        var parsed = gelly.parse(code, {keywords: keywords});
        var el = document.getElementById("parsed");
        var parsedRules = gelly.parse(rulesCode);
        //console.log(rules.toPrettyString());
        el.value = parsed ? parsed.toPrettyString('') : "parse error";
        //eval(rule);
      } catch(ex) {
        errEl.innerText = ex.message;
      }
      var rules = {};
      var rule = compile(parsedRules);
      //console.log("Rules: ", rule);
      eval(rule);
      var ast = parsed;
      if(!ast) {
        console.error("Parse error, apparently.");
        return;
      }
      console.log(rule);
      ast = aterm.traversal.innermost(function(t) {
        var result;
        for(var rule in rules) {
          if(rules.hasOwnProperty(rule)) {
            result = rules[rule](t);
            if(result) {
              return result;
            }
          }
        }
        return null;
      }, ast);
      var transformedEl = document.getElementById("transformed");
      transformedEl.value = ast.toPrettyString("");
    }
    init();
  </script>
</body>
</html>


